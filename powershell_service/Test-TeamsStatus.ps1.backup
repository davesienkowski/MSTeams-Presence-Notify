# Test script for Teams Status Server
# Verifies Teams installation, log files, and HTTP server

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Teams Status Server - Diagnostics" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

$AllTestsPassed = $true

# Test 1: Check Teams installation
Write-Host "[1/6] Checking Teams installation..." -ForegroundColor Yellow
$TeamsProcess = Get-Process -Name "ms-teams" -ErrorAction SilentlyContinue

if ($TeamsProcess) {
    Write-Host "  ✓ Teams is running" -ForegroundColor Green
    Write-Host "    Process ID: $($TeamsProcess.Id)" -ForegroundColor Gray
} else {
    Write-Host "  ✗ Teams is NOT running" -ForegroundColor Red
    Write-Host "    Please start Microsoft Teams and try again" -ForegroundColor Yellow
    $AllTestsPassed = $false
}

# Test 2: Check New Teams log directory
Write-Host "`n[2/6] Checking New Teams log directory..." -ForegroundColor Yellow
$NewTeamsLogPath = "$env:LOCALAPPDATA\Packages\MSTeams_8wekyb3d8bbwe\LocalCache\Microsoft\MSTeams\Logs\"

if (Test-Path $NewTeamsLogPath) {
    Write-Host "  ✓ New Teams log directory found" -ForegroundColor Green
    Write-Host "    Path: $NewTeamsLogPath" -ForegroundColor Gray

    $LogFiles = Get-ChildItem -Path $NewTeamsLogPath -Filter "*.log" -ErrorAction SilentlyContinue
    if ($LogFiles) {
        Write-Host "    Log files: $($LogFiles.Count)" -ForegroundColor Gray
        $LatestLog = $LogFiles | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        Write-Host "    Latest: $($LatestLog.Name) ($('{0:N2}' -f ($LatestLog.Length / 1KB)) KB)" -ForegroundColor Gray
    } else {
        Write-Host "  ⚠ No log files found (Teams may need to be restarted)" -ForegroundColor Yellow
    }
} else {
    Write-Host "  ✗ New Teams log directory NOT found" -ForegroundColor Red

    # Check Classic Teams as fallback
    $ClassicTeamsLogPath = "$env:APPDATA\Microsoft\Teams\logs.txt"
    if (Test-Path $ClassicTeamsLogPath) {
        Write-Host "  ✓ Classic Teams log file found (fallback)" -ForegroundColor Yellow
        Write-Host "    Path: $ClassicTeamsLogPath" -ForegroundColor Gray
        Write-Host "    Note: Classic Teams support ends July 1, 2025" -ForegroundColor Yellow
    } else {
        Write-Host "  ✗ No Teams logs found at all" -ForegroundColor Red
        $AllTestsPassed = $false
    }
}

# Test 3: Check log content
Write-Host "`n[3/6] Checking log content..." -ForegroundColor Yellow

try {
    if (Test-Path $NewTeamsLogPath) {
        $LogFiles = Get-ChildItem -Path $NewTeamsLogPath -Filter "*.log" -ErrorAction SilentlyContinue |
                    Sort-Object LastWriteTime -Descending |
                    Select-Object -First 1

        if ($LogFiles) {
            $LogContent = Get-Content -Path $LogFiles[0].FullName -Tail 500 -ErrorAction SilentlyContinue | Out-String

            if ($LogContent -match "SetBadge|SetTaskbarIconOverlay") {
                Write-Host "  ✓ Status patterns found in logs" -ForegroundColor Green

                # Try to detect current status
                if ($LogContent -match "SetBadge Setting badge:.*available") {
                    Write-Host "    Detected: Available" -ForegroundColor Gray
                } elseif ($LogContent -match "SetBadge Setting badge:.*busy") {
                    Write-Host "    Detected: Busy" -ForegroundColor Gray
                } elseif ($LogContent -match "SetBadge Setting badge:.*away") {
                    Write-Host "    Detected: Away" -ForegroundColor Gray
                } elseif ($LogContent -match "SetBadge Setting badge:.*doNotDisturb") {
                    Write-Host "    Detected: Do Not Disturb" -ForegroundColor Gray
                } else {
                    Write-Host "    Detected: (checking...)" -ForegroundColor Gray
                }
            } else {
                Write-Host "  ⚠ Status patterns NOT found in recent logs" -ForegroundColor Yellow
                Write-Host "    Try changing your Teams status to generate log entries" -ForegroundColor Yellow
            }
        }
    }
} catch {
    Write-Host "  ⚠ Could not read log content: $_" -ForegroundColor Yellow
}

# Test 4: Check if port 8080 is available
Write-Host "`n[4/6] Checking port 8080 availability..." -ForegroundColor Yellow

$PortInUse = Get-NetTCPConnection -LocalPort 8080 -ErrorAction SilentlyContinue

if ($PortInUse) {
    Write-Host "  ⚠ Port 8080 is already in use" -ForegroundColor Yellow
    Write-Host "    Process ID: $($PortInUse.OwningProcess)" -ForegroundColor Gray

    $Process = Get-Process -Id $PortInUse.OwningProcess -ErrorAction SilentlyContinue
    if ($Process) {
        Write-Host "    Process Name: $($Process.ProcessName)" -ForegroundColor Gray
        if ($Process.ProcessName -like "*powershell*") {
            Write-Host "    This might be our Teams Status Server already running!" -ForegroundColor Cyan
        }
    }
} else {
    Write-Host "  ✓ Port 8080 is available" -ForegroundColor Green
}

# Test 5: Check network configuration
Write-Host "`n[5/6] Checking network configuration..." -ForegroundColor Yellow

$IPv4Addresses = Get-NetIPAddress -AddressFamily IPv4 |
                 Where-Object {$_.IPAddress -notlike "127.*" -and $_.IPAddress -notlike "169.254.*"} |
                 Select-Object -ExpandProperty IPAddress

if ($IPv4Addresses) {
    Write-Host "  ✓ Network adapters found" -ForegroundColor Green
    foreach ($IP in $IPv4Addresses) {
        Write-Host "    $IP" -ForegroundColor Gray
    }
    Write-Host "`n  PyPortal should connect to: http://$($IPv4Addresses[0]):8080/status" -ForegroundColor Cyan
} else {
    Write-Host "  ⚠ No non-loopback IPv4 addresses found" -ForegroundColor Yellow
}

# Test 6: Try to start server (if not running)
Write-Host "`n[6/6] Testing server startup..." -ForegroundColor Yellow

if (-not $PortInUse) {
    Write-Host "  Attempting to start server for 5 seconds..." -ForegroundColor Gray

    # Start server in background job
    $TestJob = Start-Job -ScriptBlock {
        param($ScriptPath)
        & $ScriptPath -CheckInterval 2
    } -ArgumentList "$PSScriptRoot\TeamsStatusServer.ps1"

    Start-Sleep -Seconds 3

    # Test HTTP endpoint
    try {
        $Response = Invoke-WebRequest -Uri "http://localhost:8080/status" -TimeoutSec 2 -ErrorAction Stop
        $Status = $Response.Content | ConvertFrom-Json

        Write-Host "  ✓ Server started successfully!" -ForegroundColor Green
        Write-Host "    Status: $($Status.availability)" -ForegroundColor Gray
        Write-Host "    Color: $($Status.color)" -ForegroundColor Gray
    } catch {
        Write-Host "  ⚠ Could not connect to server: $_" -ForegroundColor Yellow
    }

    # Stop test server
    Stop-Job $TestJob -ErrorAction SilentlyContinue
    Remove-Job $TestJob -ErrorAction SilentlyContinue
} else {
    Write-Host "  Skipped (port already in use - server may already be running)" -ForegroundColor Yellow
    Write-Host "  Try testing manually: Invoke-WebRequest http://localhost:8080/status" -ForegroundColor Cyan
}

# Summary
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Summary" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

if ($AllTestsPassed -and $TeamsProcess) {
    Write-Host "✓ All critical tests passed!" -ForegroundColor Green
    Write-Host "`nYou're ready to run the Teams Status Server:" -ForegroundColor White
    Write-Host "  powershell -ExecutionPolicy Bypass -File TeamsStatusServer.ps1`n" -ForegroundColor Cyan
} else {
    Write-Host "⚠ Some tests failed or require attention" -ForegroundColor Yellow
    Write-Host "`nPlease address the issues above before running the server.`n" -ForegroundColor White
}

# Next steps
Write-Host "Next Steps:" -ForegroundColor Yellow
Write-Host "  1. Start the server: powershell -ExecutionPolicy Bypass -File TeamsStatusServer.ps1" -ForegroundColor White
Write-Host "  2. Test endpoint: Invoke-WebRequest http://localhost:8080/status" -ForegroundColor White
Write-Host "  3. Get your IP: ipconfig" -ForegroundColor White
Write-Host "  4. Configure PyPortal with: http://<your-ip>:8080/status`n" -ForegroundColor White
