# Home Assistant Configuration Examples
# MS Teams Presence Integration via MQTT

# ============================================================================
# BASIC SENSOR CARD
# ============================================================================
# Add this to your Lovelace dashboard (configuration.yaml or UI)

type: entities
title: Teams Presence
entities:
  - entity: sensor.teams_presence_status
    name: Current Status
    icon: mdi:microsoft-teams

# ============================================================================
# GLANCE CARD WITH ATTRIBUTES
# ============================================================================

type: glance
title: Teams Status
entities:
  - entity: sensor.teams_presence_status
    name: Status
  - entity: sensor.teams_presence_status
    name: Uptime
    attribute: uptime
  - entity: sensor.teams_presence_status
    name: Last Update
    attribute: last_update

# ============================================================================
# MARKDOWN CARD WITH EMOJI
# ============================================================================

type: markdown
content: |
  ## ðŸ“Š Teams Presence Status

  **Status:** {{ states('sensor.teams_presence_status') }}

  **Emoji:** {{ state_attr('sensor.teams_presence_status', 'emoji') }}

  **Uptime:** {{ state_attr('sensor.teams_presence_status', 'uptime') }}

  **Last Updated:** {{ state_attr('sensor.teams_presence_status', 'last_update') }}

# ============================================================================
# AUTOMATIONS
# ============================================================================

# ------------------------------
# Smart Lighting Based on Status
# ------------------------------

automation:
  # Turn office light red when busy
  - alias: "Office Light - Teams Busy"
    description: "Turn office light red when in a meeting or busy"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to:
          - "Busy"
          - "InAMeeting"
          - "InACall"
          - "DoNotDisturb"
    action:
      - service: light.turn_on
        target:
          entity_id: light.office_light
        data:
          rgb_color: [255, 0, 0]
          brightness: 255
          transition: 1

  # Turn office light green when available
  - alias: "Office Light - Teams Available"
    description: "Turn office light green when available"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "Available"
    action:
      - service: light.turn_on
        target:
          entity_id: light.office_light
        data:
          rgb_color: [0, 255, 0]
          brightness: 180
          transition: 1

  # Turn office light yellow when away
  - alias: "Office Light - Teams Away"
    description: "Turn office light yellow when away"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to:
          - "Away"
          - "BeRightBack"
    action:
      - service: light.turn_on
        target:
          entity_id: light.office_light
        data:
          rgb_color: [255, 255, 0]
          brightness: 150
          transition: 1

  # Dim office light when offline
  - alias: "Office Light - Teams Offline"
    description: "Dim office light when offline"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "Offline"
    action:
      - service: light.turn_on
        target:
          entity_id: light.office_light
        data:
          brightness: 50
          transition: 2

# ------------------------------
# Family Notifications
# ------------------------------

  # Notify family when available
  - alias: "Notify Family - Available for Dinner"
    description: "Tell family when you're available to join for dinner"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "Available"
    condition:
      - condition: time
        after: "17:00:00"
        before: "19:00:00"
    action:
      - service: notify.mobile_app_spouse_phone
        data:
          message: "Dad's status is now Available - ready for dinner!"
          title: "Teams Status Update"
          data:
            tag: "teams_status"
            group: "teams"

  # Announce to Google Home when in a meeting
  - alias: "Announce Meeting to Family"
    description: "Let family know when you're in a meeting"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to:
          - "InAMeeting"
          - "InACall"
    action:
      - service: tts.google_say
        target:
          entity_id: media_player.living_room_speaker
        data:
          message: "Please be quiet, Dad is in a meeting"

# ------------------------------
# Do Not Disturb Automation
# ------------------------------

  # Enable Do Not Disturb mode
  - alias: "Do Not Disturb - Teams Meeting"
    description: "Activate do not disturb when in a Teams meeting"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to:
          - "InAMeeting"
          - "InACall"
          - "DoNotDisturb"
    action:
      # Mute doorbell
      - service: switch.turn_off
        target:
          entity_id: switch.doorbell_chime

      # Lower smart speaker volume
      - service: media_player.volume_set
        target:
          entity_id:
            - media_player.living_room_speaker
            - media_player.kitchen_speaker
        data:
          volume_level: 0.1

      # Turn on "On Air" sign
      - service: switch.turn_on
        target:
          entity_id: switch.on_air_sign

      # Send notification to family members
      - service: notify.family_group
        data:
          message: "Dad is now in a meeting - please keep noise down"
          title: "Do Not Disturb"

  # Disable Do Not Disturb mode
  - alias: "Do Not Disturb - Teams Meeting Ended"
    description: "Deactivate do not disturb when meeting ends"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        from:
          - "InAMeeting"
          - "InACall"
          - "DoNotDisturb"
    action:
      # Enable doorbell
      - service: switch.turn_on
        target:
          entity_id: switch.doorbell_chime

      # Restore speaker volume
      - service: media_player.volume_set
        target:
          entity_id:
            - media_player.living_room_speaker
            - media_player.kitchen_speaker
        data:
          volume_level: 0.5

      # Turn off "On Air" sign
      - service: switch.turn_off
        target:
          entity_id: switch.on_air_sign

# ------------------------------
# Office Environment Automation
# ------------------------------

  # Adjust climate when working
  - alias: "Climate - Working Hours Busy"
    description: "Adjust temperature when busy in office"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to:
          - "Busy"
          - "InAMeeting"
          - "InACall"
    condition:
      - condition: time
        after: "08:00:00"
        before: "18:00:00"
      - condition: state
        entity_id: climate.office_ac
        state: "off"
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.office_ac
        data:
          temperature: 22
          hvac_mode: "cool"

  # Turn off AC when offline for 30 minutes
  - alias: "Climate - Offline Energy Save"
    description: "Turn off office AC when offline for extended period"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "Offline"
        for:
          minutes: 30
    action:
      - service: climate.turn_off
        target:
          entity_id: climate.office_ac

# ------------------------------
# Smart Desk Automation
# ------------------------------

  # Raise standing desk when available
  - alias: "Standing Desk - Available Reminder"
    description: "Remind to use standing desk when available"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "Available"
    condition:
      - condition: time
        after: "10:00:00"
        before: "16:00:00"
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states.cover.standing_desk.last_changed)) > 7200 }}"
    action:
      - service: cover.set_cover_position
        target:
          entity_id: cover.standing_desk
        data:
          position: 75  # Standing height

      - service: notify.mobile_app_my_phone
        data:
          message: "Time to stand! Desk adjusted to standing height"
          title: "Standing Desk Reminder"

# ------------------------------
# Security & Privacy
# ------------------------------

  # Activate privacy mode when in sensitive meetings
  - alias: "Privacy - Sensitive Meeting"
    description: "Disable cameras and microphones during sensitive meetings"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
        to: "InAMeeting"
    condition:
      - condition: time
        after: "09:00:00"
        before: "17:00:00"
      - condition: state
        entity_id: calendar.work_calendar
        state: "on"
      - condition: template
        value_template: "{{ 'confidential' in state_attr('calendar.work_calendar', 'message') | lower }}"
    action:
      # Disable security cameras in office
      - service: camera.turn_off
        target:
          entity_id:
            - camera.office_camera
            - camera.desk_camera

      # Mute smart displays
      - service: media_player.volume_mute
        target:
          entity_id:
            - media_player.office_display
        data:
          is_volume_muted: true

# ------------------------------
# Status History Tracking
# ------------------------------

  # Log status changes to Google Sheets (via IFTTT or similar)
  - alias: "Log Teams Status Changes"
    description: "Track all status changes for productivity analysis"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
    action:
      - service: rest_command.log_to_sheets
        data:
          timestamp: "{{ now().isoformat() }}"
          status: "{{ states('sensor.teams_presence_status') }}"
          previous_status: "{{ trigger.from_state.state }}"
          duration: "{{ (as_timestamp(now()) - as_timestamp(trigger.from_state.last_changed)) | int }}"

# ============================================================================
# TEMPLATE SENSORS
# ============================================================================

# Create additional helpful sensors based on Teams presence

sensor:
  - platform: template
    sensors:
      # Human-readable status
      teams_status_friendly:
        friendly_name: "Teams Status"
        value_template: >-
          {% set status = states('sensor.teams_presence_status') %}
          {% if status == 'Available' %}
            Available to chat
          {% elif status == 'Busy' %}
            Busy - do not disturb
          {% elif status == 'InAMeeting' %}
            In a meeting
          {% elif status == 'InACall' %}
            On a call
          {% elif status == 'Away' %}
            Away from desk
          {% elif status == 'BeRightBack' %}
            Be right back
          {% elif status == 'DoNotDisturb' %}
            Do not disturb
          {% elif status == 'Offline' %}
            Offline
          {% else %}
            Unknown
          {% endif %}
        icon_template: mdi:microsoft-teams

      # Is user available?
      teams_is_available:
        friendly_name: "Is Available"
        value_template: >-
          {{ states('sensor.teams_presence_status') == 'Available' }}
        icon_template: >-
          {% if is_state('sensor.teams_presence_status', 'Available') %}
            mdi:check-circle
          {% else %}
            mdi:close-circle
          {% endif %}

      # Is user in meeting?
      teams_in_meeting:
        friendly_name: "In Meeting"
        value_template: >-
          {{ states('sensor.teams_presence_status') in ['InAMeeting', 'InACall'] }}
        icon_template: >-
          {% if states('sensor.teams_presence_status') in ['InAMeeting', 'InACall'] %}
            mdi:video
          {% else %}
            mdi:video-off
          {% endif %}

      # Working hours status
      teams_working_status:
        friendly_name: "Working Status"
        value_template: >-
          {% set status = states('sensor.teams_presence_status') %}
          {% if status in ['Offline', 'Unknown'] %}
            Not Working
          {% elif status == 'Available' %}
            Available
          {% elif status in ['Busy', 'InAMeeting', 'InACall', 'DoNotDisturb'] %}
            Busy
          {% else %}
            Away
          {% endif %}

# ============================================================================
# BINARY SENSORS
# ============================================================================

binary_sensor:
  - platform: template
    sensors:
      # Binary sensor for "do not disturb" state
      teams_do_not_disturb:
        friendly_name: "Teams Do Not Disturb"
        device_class: occupancy
        value_template: >-
          {{ states('sensor.teams_presence_status') in
             ['Busy', 'InAMeeting', 'InACall', 'DoNotDisturb'] }}

      # Binary sensor for "at desk"
      teams_at_desk:
        friendly_name: "At Desk"
        device_class: presence
        value_template: >-
          {{ states('sensor.teams_presence_status') not in
             ['Offline', 'Away', 'Unknown'] }}

# ============================================================================
# INPUT HELPERS
# ============================================================================

# Create these in Home Assistant UI: Settings â†’ Devices & Services â†’ Helpers

# input_boolean.teams_notification_enabled
#   Toggle to enable/disable Teams status notifications

# input_select.teams_lighting_mode
#   Options: auto, manual, off
#   Control how lighting responds to Teams status

# ============================================================================
# CONDITIONAL AUTOMATIONS BASED ON HELPERS
# ============================================================================

automation:
  - alias: "Teams Lighting - Conditional"
    description: "Only control lights if auto mode enabled"
    trigger:
      - platform: state
        entity_id: sensor.teams_presence_status
    condition:
      - condition: state
        entity_id: input_select.teams_lighting_mode
        state: "auto"
    action:
      # Your lighting automation here
      - choose:
          - conditions:
              - condition: state
                entity_id: sensor.teams_presence_status
                state: "Available"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.office_light
                data:
                  rgb_color: [0, 255, 0]

# ============================================================================
# SCRIPTS
# ============================================================================

script:
  # Manually check Teams status
  teams_status_check:
    alias: "Check Teams Status"
    sequence:
      - service: mqtt.publish
        data:
          topic: "homeassistant/sensor/teams_presence/command"
          payload: "status"

      - service: notify.mobile_app_my_phone
        data:
          message: "Current status: {{ states('sensor.teams_presence_status') }}"
          title: "Teams Status"

  # Toggle Do Not Disturb mode
  teams_dnd_toggle:
    alias: "Toggle Teams DND Mode"
    sequence:
      - if:
          - condition: state
            entity_id: binary_sensor.teams_do_not_disturb
            state: "on"
        then:
          # Already in DND, turn off features
          - service: scene.turn_on
            target:
              entity_id: scene.normal_mode
        else:
          # Not in DND, activate features
          - service: scene.turn_on
            target:
              entity_id: scene.do_not_disturb_mode

# ============================================================================
# SCENES
# ============================================================================

scene:
  - name: "Do Not Disturb Mode"
    entities:
      light.office_light:
        state: on
        rgb_color: [255, 0, 0]
        brightness: 255
      switch.doorbell_chime:
        state: off
      media_player.living_room_speaker:
        state: on
        volume_level: 0.1

  - name: "Normal Mode"
    entities:
      light.office_light:
        state: on
        brightness: 180
      switch.doorbell_chime:
        state: on
      media_player.living_room_speaker:
        state: on
        volume_level: 0.5

# ============================================================================
# LOVELACE DASHBOARD EXAMPLE
# ============================================================================

# Complete dashboard card with all features
# Add to ui-lovelace.yaml or via UI

views:
  - title: Teams Presence
    path: teams
    badges: []
    cards:
      # Status overview
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # ðŸ“Š Teams Presence Monitor
              Real-time Microsoft Teams status integration

          - type: glance
            entities:
              - entity: sensor.teams_presence_status
                name: Status
              - entity: binary_sensor.teams_do_not_disturb
                name: DND Active
              - entity: binary_sensor.teams_at_desk
                name: At Desk

          # Status details
          - type: entities
            title: Status Details
            entities:
              - entity: sensor.teams_presence_status
                name: Current Status
              - entity: sensor.teams_status_friendly
                name: Description
              - type: attribute
                entity: sensor.teams_presence_status
                attribute: uptime
                name: Uptime
              - type: attribute
                entity: sensor.teams_presence_status
                attribute: last_update
                name: Last Update

          # Quick actions
          - type: horizontal-stack
            cards:
              - type: button
                name: Check Status
                icon: mdi:refresh
                tap_action:
                  action: call-service
                  service: script.teams_status_check

              - type: button
                name: Toggle DND
                icon: mdi:bell-off
                tap_action:
                  action: call-service
                  service: script.teams_dnd_toggle

      # History graph
      - type: history-graph
        title: Teams Status History
        hours_to_show: 8
        entities:
          - entity: sensor.teams_presence_status

# ============================================================================
# NOTES
# ============================================================================
#
# Additional integration ideas:
#
# 1. Calendar Integration:
#    - Compare Teams status with Outlook calendar
#    - Auto-update status based on calendar events
#
# 2. Productivity Tracking:
#    - Log time in each status
#    - Generate daily/weekly reports
#    - Track focus time vs meeting time
#
# 3. Smart Home Scenes:
#    - Create complete room scenes based on status
#    - Adjust blinds, temperature, lighting together
#
# 4. Voice Assistant Commands:
#    - "Alexa, what's my Teams status?"
#    - "Hey Google, am I in a meeting?"
#
# 5. Wearable Integration:
#    - Send status to smartwatch
#    - Haptic feedback on status changes
#
# ============================================================================
